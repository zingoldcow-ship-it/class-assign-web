<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>반배정 도우미 (브라우저 전용)</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#475569; --accent:#60a5fa; --danger:#dc2626; --ok:#16a34a; --desc:#1d4ed8; --subtle:#64748b; --titleAccent:#0f172a; --border:rgba(15,23,42,.12); }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{padding:16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(246,247,251,.9);backdrop-filter:blur(8px);z-index:50;}
    .wrap{max-width:1300px;margin:0 auto;padding:14px;}
    h1{margin:0;font-size:18px;}
    /* Intro title larger */
    #headerIntro h1{font-size:28px; letter-spacing:-0.2px;}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}
    .sub .flow{color:var(--desc)}
    .sub .privacy{color:var(--subtle)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{font-size:12px;border:1px solid rgba(15,23,42,.14);padding:6px 10px;border-radius:999px;color:var(--muted);background:rgba(15,23,42,.02)}
    .pill.ok{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12);color:var(--text)}
    .pill.total{border-color:rgba(37,99,235,.35);background:rgba(37,99,235,.10);color:var(--text)}
    .pill.warn{border-color:rgba(255,107,107,.55);color:#b42318;background:rgba(255,107,107,.10)}
    /* Big split tabs (화면 양분 형태) */
    .tabs{display:flex;gap:12px;margin-top:12px;}
    .tabBtn{
      flex:1;
      background:rgba(15,23,42,.05);
      border:1px solid rgba(15,23,42,.12);
      color:var(--text);
      padding:12px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:14px;
    }
    .tabBtn.active{background:rgba(96,165,250,.40);color:#0b1220;border-color:rgba(37,99,235,.20)}
    .tabBtn:disabled{opacity:.45}
    /* (keep base tabBtn here; size tweaks for levelTabs are set near the bottom) */
    .app{display:grid;grid-template-columns:340px 1fr;gap:14px;align-items:start}
    @media (max-width: 980px){ .app{grid-template-columns:1fr;} }
    .card{background:var(--card);border:1px solid rgba(15,23,42,.08);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);}
    .panelTitle{font-size:14px;margin:0 0 10px 0;}
    .divider{height:1px;background:rgba(15,23,42,.08);margin:12px 0;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    /* Setup panel readability (라벨이 더 크고, 입력값은 한 단계 작게) */
    #setupTab aside.card label{font-size:16px; line-height:1.25; font-weight:900; color:var(--text); opacity:.95;}
    #setupTab aside.card input[type=file],
    #setupTab aside.card input[type=number],
    #setupTab aside.card select{font-size:14px;}

    /* 설정 요약 박스 */
    .summaryBox{margin:10px 0 6px 0; padding:10px 12px; border:1px solid rgba(15,23,42,.10); border-radius:12px; background:rgba(15,23,42,.03);}
    .summaryBox .t{font-weight:900; margin-bottom:6px;}
    .summaryBox .l{font-size:13px; color:var(--muted); line-height:1.35;}

    /* 실행 버튼 하단 고정(설정 패널 내) */
    .stickyRun{position:sticky; bottom:0; padding-top:10px; background:linear-gradient(to bottom, rgba(246,247,251,0), rgba(246,247,251,.92) 22%, rgba(246,247,251,.98)); border-top:1px solid rgba(15,23,42,.08); margin-top:10px;}
    .stickyRun .tip{font-size:12px; color:#111827; margin-top:8px; background:rgba(254, 249, 195, 1); border:1px solid rgba(245, 158, 11, .55); padding:8px 10px; border-radius:12px;}




    select:focus{border-color:rgba(96,165,250,.8)}
    option{background:#ffffff;color:var(--text)}
    input[type=file]{padding:10px;border-radius:12px;border:1px dashed rgba(15,23,42,.18);background:rgba(15,23,42,.03);color:var(--text)}
    input[type=number],select{padding:10px;border-radius:12px;border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.03);color:var(--text)}
    input[type=range]{width:100%;accent-color:var(--accent)}
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin-top:6px}
    button{background:var(--accent);border:none;color:#0b1220;padding:11px 12px;border-radius:12px;font-weight:900;cursor:pointer;width:auto}
    /* Lighter blue for result download */
    .downloadBtn{display:inline-flex;align-items:center;gap:10px;padding:14px 18px;border-radius:16px;font-size:15px;font-weight:950;min-width:220px;background:rgba(196,181,253,.35);border:1px solid rgba(139,92,246,.25);}
    .downloadBtn:hover{background:rgba(96,165,250,.42)}
    .downloadBtn .btnIcon{font-size:18px;line-height:1;}

    .btnSecondary{background:rgba(15,23,42,.07);border:1px solid rgba(15,23,42,.14);color:var(--text)}
    .btn, .btnSecondary, #fileBtn, #runBtn{width:100%}
    .tabBtn{width:auto}
    .homeBtn{width:auto}

    button:disabled{opacity:.4;cursor:not-allowed}
    .small{font-size:12px;color:var(--muted)}
    .subNote{display:block;font-size:12px;line-height:1.25;color:var(--subtle);font-weight:700;margin-top:2px;}

    .danger{color:var(--danger)}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:100;}
    .overlay .box{background:var(--card);border:1px solid rgba(15,23,42,.14);padding:16px;border-radius:14px;max-width:520px;width:calc(100% - 28px);}
    .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(15,23,42,.2);border-top-color:rgba(122,162,255,.9);animation:spin 1s linear infinite;display:inline-block;vertical-align:-4px;margin-right:8px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;white-space:nowrap}
    th{color:var(--text);font-weight:800;position:sticky;top:0;background:rgba(253,230,138,.55)}
    .chartGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 980px){ .chartGrid{grid-template-columns:1fr;} }
    .chartBox{height:260px;position:relative}
    canvas{width:100% !important;height:100% !important;display:block}
    a{color:var(--accent)}

    /* Header home button */
    .headerTop{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .homeBtn{display:inline-flex;align-items:center;gap:10px;background:rgba(37,99,235,.10);border:1px solid rgba(37,99,235,.25);color:var(--text);padding:12px 14px;border-radius:999px;cursor:pointer;font-weight:950;font-size:16px;}
    .homeBtn:hover{background:rgba(37,99,235,.14)}
    
    .mintBtn{background:rgba(16,185,129,.14);border:1px solid rgba(16,185,129,.35);color:var(--text)}
    .mintBtn:hover{background:rgba(16,185,129,.18)}
    /* Light pink upload button */
    .pinkBtn{background:rgba(244,114,182,.18);border:1px solid rgba(244,114,182,.40);color:var(--text)}
    .pinkBtn:hover{background:rgba(244,114,182,.24)}
.homeIcon{width:22px;height:22px;display:inline-block}

    /* Accordion (설정 섹션 접기) */
    .acc{border:1px solid rgba(15,23,42,.10);border-radius:14px;background:rgba(15,23,42,.03);padding:10px 12px;margin:10px 0;}
    /* 섹션 제목(기본 설정/학업·관계·민원·다문화 설정 등) 가독성 강화 */
    .acc > summary{cursor:pointer;list-style:none;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;font-weight:900;font-size:18px;color:var(--titleAccent);}
    .acc > summary::-webkit-details-marker{display:none;}
    .acc > summary .subline{display:block;font-weight:700;color:var(--muted);font-size:13px;margin-top:4px;}
    /* 토글(화살표)을 더 크게/눈에 띄게 */
    .acc > summary::after{content:"▾";opacity:.95;margin-top:2px;font-size:18px;transition:transform .15s ease;color:var(--titleAccent);}
    details[open].acc > summary::after{transform:rotate(90deg)}
    /* Accordion header contrast (active vs inactive) */
    .acc > summary span{font-weight:950;color:var(--text);}
    details[open].acc > summary span{color:var(--desc);}
    details[open].acc{background:rgba(96,165,250,.10);border-color:rgba(29,78,216,.22);}

    .accInner{padding-top:10px;}

    /* Accordion 사용 안내 문구 */
    .accHint{font-size:16px;line-height:1.35;color:var(--text);font-weight:900;opacity:.95;}

    /* File upload button */
    .fileInputHidden{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;}
  
    /* v4.1.1: 도움말 토글(요청·제약) + 가독성 */
    #accConstraints select{ font-size:0.92em; }
    #accConstraints label{ font-weight:600; }
    .helpRow{ display:flex; justify-content:flex-end; margin-top:4px; margin-bottom:10px; }
    .helpBtn{
      display:inline-flex; align-items:center; gap:6px;
      background:rgba(255,233,166,0.10);
      border:1px solid rgba(255,233,166,0.45);
      color:var(--titleAccent);
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .helpBtn:hover{ background:rgba(255,233,166,0.16); }
    .helpBtn.open{ background:rgba(255,233,166,0.22); }
    .helpIcon{
      width:16px; height:16px; display:inline-block; position:relative;
      border-radius:50%;
      background:rgba(255,233,166,0.20);
      border:1px solid rgba(255,233,166,0.55);
    }
    .helpIcon::before{
      content:"i";
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:12px; line-height:1;
    }
    .helpText{
      margin-top:6px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(15,23,42,0.04);
      border:1px solid rgba(15,23,42,0.08);
      line-height:1.45;
    }

  
    /* Intro guide */
    .guideList{margin:10px 0 0 20px;padding:0;}
    /* 시작화면 '앱 사용방법' 가독성 강화: 번호 라인은 볼드, 설명(가중치/분리/배려) 부분은 일반 두께 */
    .guideList > li{margin:10px 0;line-height:1.5;font-weight:700;}
    .guideList > li .small{font-weight:400;}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;}

    /* Intro sections to reduce "all text" feel */
    .introSection{padding:12px;border:1px solid rgba(15,23,42,.10);background:rgba(15,23,42,.02);border-radius:12px;margin-top:12px}
    .introSection .panelTitle{margin:0 0 6px 0;font-size:14px}
    /* App how-to header (ivory card) */
    .howtoCard{background:rgba(255, 250, 240, 1);border-color:rgba(245,158,11,.25)}
    /* Intro section title (no "card-in-card" for subtitles) */
    .sectionTitle{
      margin:0 0 10px 0;
      font-size:18px;
      font-weight:950;
      letter-spacing:-0.2px;
      color:#7c2d12;
    }
    /* Keep a card-in-card look ONLY for 안내 내용 */
    .innerCard{
      padding:10px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.72);
      border:1px solid rgba(15,23,42,.10);
      box-shadow:0 6px 16px rgba(0,0,0,.10);
    }

    /* Note box (high contrast on light UI) */
    .noteBox{padding:10px 12px;border-radius:12px;background:rgba(254,249,195,1);border:1px solid rgba(245,158,11,.45);color:#111827;}

    /* Intro: separate action buttons area */
    .introActions{margin-top:12px;padding:12px;border-radius:12px;border:1px solid rgba(15,23,42,.10);background:rgba(15,23,42,.02);}

    /* Result header polish */
    .resultHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .resultPills{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    #resultTab .pill{font-size:13px;padding:8px 12px;}
    #resultTab .pill.ok{background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.40)}
    #resultTab .pill.warn{background:rgba(255,107,107,.14);border-color:rgba(255,107,107,.55);color:#7f1d1d;font-weight:900;}
    #resultTab .pill.care{background:rgba(245,158,11,.14);border-color:rgba(245,158,11,.35);color:#78350f;font-weight:900;}

  
    /* --- Layout polish: 좌측 설정/우측 미리보기 균형(스크롤 분리) --- */
    #setupTab .app{align-items:stretch; min-height: calc(100vh - 210px);}
    #setupTab aside.card{
      height: calc(100vh - 170px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #setupTab .asideScroll{
      overflow:auto;
      padding-right:6px;
      margin-top:10px;
    }
    #setupTab .rightCol{
      height: calc(100vh - 170px);
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* --- Select(토글) 크기 통일 --- */
    #setupTab aside.card select{
      width: 260px;
      max-width: 100%;
      min-height: 44px;
      padding: 10px 12px;
    }

    /* --- Result spacing --- */
    #resultTab .small{line-height:1.55}
    .unsatTitle{font-weight:900; font-size:14px;}


    /* Header app title emphasis + helper icon */
    #headerApp h1{font-size:22px; letter-spacing:-0.2px;}
    .titleRow{display:flex; align-items:center; gap:10px;}
    .helperIcon{width:28px; height:28px; flex:0 0 auto;}
    /* Smaller buttons inside 3-level summary area */
    #levelTabs .tabBtn{padding:8px 10px; font-size:13px;}
</style>
</head>
<body>
<header id="headerIntro">
  <div class="wrap">
    <h1>📘 반배정 도우미 웹앱</h1>
    <div class="sub" style="margin-top:8px">
      <div class="privacy">🔐 모든 처리는 <b>사용자 브라우저에서만</b> 이루어지며, 업로드한 파일과 데이터는 <b>어떤 서버로도 전송되지 않습니다</b>.</div>
    </div>
  </div>
</header>

<header id="headerApp" style="display:none;">
  <div class="wrap">
    <div class="headerTop">
      <div>
        <div class="titleRow">
          <h1>📘 반배정 도우미 웹앱</h1>
          <svg class="helperIcon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <!-- head -->
            <circle cx="32" cy="28" r="14" fill="#fde68a" stroke="#92400e" stroke-width="2"/>
            <!-- headset band -->
            <path d="M18 28c0-8 6-14 14-14s14 6 14 14" fill="none" stroke="#1e3a8a" stroke-width="3" stroke-linecap="round"/>
            <!-- ear pads -->
            <rect x="14" y="28" width="8" height="14" rx="4" fill="#60a5fa" stroke="#1e3a8a" stroke-width="2"/>
            <rect x="42" y="28" width="8" height="14" rx="4" fill="#60a5fa" stroke="#1e3a8a" stroke-width="2"/>
            <!-- mic -->
            <path d="M46 42c-3 4-7 6-12 6" fill="none" stroke="#1e3a8a" stroke-width="3" stroke-linecap="round"/>
            <circle cx="33" cy="49" r="2.2" fill="#1e3a8a"/>
            <!-- smile -->
            <path d="M26 30c2 3 10 3 12 0" fill="none" stroke="#78350f" stroke-width="2.5" stroke-linecap="round"/>
            <!-- sparkle -->
            <path d="M52 14l2 5 5 2-5 2-2 5-2-5-5-2 5-2z" fill="#f472b6" opacity="0.95"/>
          </svg>
        </div>
        <div class="row" style="margin-top:10px">
          <span class="pill ok">서버 전송 없음</span>
          <span class="pill" id="filePill">엑셀 미선택</span>
          <span class="pill" id="rowsPill">0명</span>
          <span class="pill" id="statusPill">대기</span>
        </div>
      </div>
      <button type="button" class="homeBtn" id="homeBtn" title="홈(안내)으로">
        <!-- colored home icon (to avoid the bland grayscale look) -->
        <svg class="homeIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <!-- roof -->
          <path d="M3.5 10.6 12 4l8.5 6.6" fill="#60a5fa" stroke="#1e3a8a" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- house body -->
          <path d="M6 10.2V20c0 .55.45 1 1 1h10c.55 0 1-.45 1-1v-9.8" fill="#fbbf24" stroke="#92400e" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- door -->
          <path d="M10 21v-6.2c0-.44.36-.8.8-.8h2.4c.44 0 .8.36.8.8V21" fill="#fff" stroke="#78350f" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          <!-- window -->
          <path d="M7.8 13.3h3.1v3.1H7.8z" fill="#e0f2fe" stroke="#0c4a6e" stroke-width="1.1"/>
        </svg>
        홈
      </button>
    </div>
    <div class="tabs">
      <button class="tabBtn active" id="tabSetup">설정</button>
      <button class="tabBtn" id="tabResult" disabled>결과</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="introView">
  <div class="card">
    <div class="introSection howtoCard">
      <div class="sectionTitle" aria-label="앱 사용방법">앱 사용방법</div>
      <div class="innerCard"><ol class="guideList">
        <li>샘플 양식에 학생 정보를 입력</li>
        <li>실행 화면으로 이동</li>
        <li>엑셀(.xlsx) 업로드</li>
        <li>
          설정(반 개수/가중치/분리·배려 강도)
          <div class="small" style="margin-top:6px">
            • <b>가중치</b>: 학업/교우관계/민원 등 여러 기준 중 무엇을 더 우선할지 정합니다. 값이 높을수록 해당 기준이 더 많이 반영됩니다.<br/>
            • <b>분리 강도</b>: 강도가 높을수록 <b>분리요청을 한 학생은 가능한 한 다른 반</b>으로 배정합니다. 예) A학생이 B학생과 분리 요청을 했다면, <b>서로 다른 반</b>이 되도록 적용합니다.<br/>
            • <b>배려 강도</b>: 강도가 높을수록 <b>배려요청을 한 학생은 가능한 한 같은 반</b>으로 배정합니다. 예) C학생이 D학생과 같은 반이 되도록 요청했다면, <b>같은 반</b>이 되도록 적용합니다.
          </div>
        </li>
        <li>반배정 실행</li>
        <li>결과 확인 및 엑셀 다운로드</li>
      </ol></div>
    </div>

    <div class="introSection">
      <div class="sectionTitle" style="margin-bottom:10px">안내</div>
      <div class="innerCard">
        <div class="small">• 결과는 <b>“결과” 탭</b>에서 확인합니다.<br/>• 아이콘 안내: 🧩 특수 │ 🌏 다문화 │ 🧠 ADHD │ 🔗 분리요청 │ 🤝 배려요청</div>
      </div>
    </div>

    <div class="introSection">
      <div class="sectionTitle" style="margin-bottom:10px">샘플 양식</div>
      <div class="innerCard">
        <div class="small">
          • 처음 사용하시면 위 양식을 내려받아 <b>열 이름/형식을 유지하며 작성해주세요.</b><br/>
          <span style="color:var(--subtle)">• 모든 칸을 다 채우지 않아도 됩니다. <b>입력 가능한 항목만</b> 작성해도 실행할 수 있어요.</span>
        </div>
      </div>
    </div>

    <div class="introActions">
      <div class="btnRow">
        <a href="template.xlsx" download="반배정_양식_샘플.xlsx" style="text-decoration:none;flex:1">
          <button type="button" class="btnSecondary mintBtn" style="width:100%">샘플 양식 다운로드</button>
        </a>
        <button type="button" class="btn" id="goAppBtn" style="flex:1">실행 화면으로 이동</button>
      </div>
    </div>
  </div>
</section>

  <section id="appView" style="display:none;">

  <!-- SETUP TAB -->
  <section id="setupTab">
    <div class="app">
      <aside class="card" style="position:sticky; top:120px;">
        <h2 class="panelTitle">⚙️ 설정</h2>
        <input id="fileInput" class="fileInputHidden" type="file" accept=".xlsx" />
        <button id="fileBtn" type="button" class="btnSecondary pinkBtn"><span class="btnIcon" aria-hidden="true">⭡</span> 학생 데이터 업로드(.xlsx)</button>
        <div class="asideScroll">
        <!-- ① 기본 설정 (초기: 닫힘) -->
        <details class="acc" id="accBasic">
          <summary><span>① 기본 설정</span></summary>
          <div class="accInner">

            <label>1. 반 개수</label>
            <input id="classCount" type="number" min="2" max="30" value="10" />
            <div class="divider"></div>

            <label>2. <strong style='font-size:1.05em'>남/여 성비 균형(3단계)</strong></label>
            <select id="genderBalance">
              <option value="off">미적용</option>
              <option value="medium">보통 (반마다 남녀 차이 ±2 정도로 유지)</option>
              <option value="strong" selected>강 (반마다 남녀 차이 ±1 정도로 유지)</option>
            </select>
            <div class="divider"></div>

            <label>3. <strong style='font-size:1.05em'>시뮬레이션 정밀도(3단계)</strong><br><span class='subNote'>(높을수록 더 균형 / 느려질 수 있음)</span></label>
            <select id="iterMode">
              <option value="low">낮음 (빠르게 시도)</option>
              <option value="medium" selected>보통 (권장)</option>
              <option value="high">높음 (더 오래 계산)</option>
            </select>
          </div>
        </details>

        <!-- ② 학업·관계·민원·다문화 설정 (기본 접힘) -->
        <details class="acc" id="accWeights">
          <summary><span>② 학업·교우관계·민원 설정</span></summary>
          <div class="accInner">
            <div class="small" style="margin-top:2px; opacity:.95;">* 가중치는 “반배정 점수” 계산에 사용됩니다. <b>값이 높을수록</b> 해당 항목이 반배정에 <b>더 강하게</b> 반영됩니다.</div>
            <div style="margin-top:10px">
              <label>1. 학업성취 가중치</label>
              <input id="wAcad" type="range" min="0" max="600" value="160" step="10" />
              <div class="kv"><span>0</span><span id="wAcadV">160</span><span>600</span></div>
            </div>
            <div style="margin-top:10px">
              <label>2. 교우관계 가중치</label>
              <input id="wPeer" type="range" min="0" max="600" value="160" step="10" />
              <div class="kv"><span>0</span><span id="wPeerV">160</span><span>600</span></div>
            </div>
            <div style="margin-top:10px">
              <label>3. 학부모민원 가중치</label>
              <input id="wParent" type="range" min="0" max="600" value="260" step="10" />
              <div class="kv"><span>0</span><span id="wParentV">260</span><span>600</span></div>
            </div>
	          </div>
        </details>

        <!-- ③ 요청·제약 설정 (기본 접힘) -->
        <details class="acc" id="accConstraints">
          <summary>
            <span>
              ③ 요청·제약 설정</span>
          </summary>
          <div class="accInner">
            <label>1. <strong style='font-size:1.05em'>ADHD 학생 배정(3단계)</strong></label>
            <select id="adhdCap">
              <option value="off" selected>미적용</option>
              <option value="normal">보통 (가급적 반별 균등 분산)</option>
              <option value="strong">강 (가능한 한 균등 분산)</option>
            </select>
            <div class="helpRow">
              <button type="button" class="helpBtn" data-help="help-adhd">
                <span class="helpIcon" aria-hidden="true"></span><span>자세히</span>
              </button>
            </div>
            <div id="help-adhd" class="helpText small" hidden>• 엑셀에 <b>ADHD여부</b> 열이 있으면 Y/N로 인식합니다.<br/>• <b>보통</b>: 가능한 한 반별로 고르게 분산되도록 우선합니다.<br/>• <b>강</b>: 분산을 더 강하게 반영합니다.</div>

            <label>2. <strong style='font-size:1.05em'>특수학생 배정(3단계)</strong></label>
            <select id="specialMode">
              <option value="off" selected>미적용</option>
              <option value="medium">보통 (가급적 반별 균등 분산)</option>
              <option value="strong">강 (가능한 한 균등 분산)</option>
            </select>
            <div class="helpRow">
              <button type="button" class="helpBtn" data-help="help-special">
                <span class="helpIcon" aria-hidden="true"></span><span>자세히</span>
              </button>
            </div>
            <div id="help-special" class="helpText small" hidden>엑셀에 <b>특수여부</b> 열이 있으면 Y/N로 인식합니다.<br/>열이 없으면 모두 N으로 처리합니다.</div>
            <div class="divider"></div>

            <label>3. <strong style='font-size:1.05em'>다문화학생 배정(3단계)</strong></label>
            <select id="multiMode">
              <option value="off" selected>미적용</option>
              <option value="medium">보통 (가급적 반별 균등 분산)</option>
              <option value="strong">강 (가능한 한 균등 분산)</option>
            </select>
            <div class="helpRow">
              <button type="button" class="helpBtn" data-help="help-multi">
                <span class="helpIcon" aria-hidden="true"></span><span>자세히</span>
              </button>
            </div>
            <div id="help-multi" class="helpText small" hidden>엑셀에 <b>다문화여부</b> 열이 있으면 Y/N로 인식합니다.<br/>열이 없으면 모두 N으로 처리합니다.</div>
            <div class="divider"></div>


            <label>4. <strong style='font-size:1.05em'>학폭(가해) 학생 배정(3단계)</strong></label>
            <select id="bullyMode">
              <option value="off" selected>미적용</option>
              <option value="medium">보통 (가급적 반별 분산 · 1반 1명 권장)</option>
              <option value="strong">강 (가능한 한 반별 분산 · 1반 1명 우선)</option>
            </select>
            <div class="helpRow">
              <button type="button" class="helpBtn" data-help="help-bully">
                <span class="helpIcon" aria-hidden="true"></span><span>자세히</span>
              </button>
            </div>
            <div id="help-bully" class="helpText small" hidden>엑셀에 <b>학폭여부</b> 열이 있으면 Y/N로 인식합니다.<br/>• <b>보통</b>: 가능한 한 반별로 분산되도록 우선합니다.<br/>• <b>강</b>: 분산을 더 강하게 반영하며, 1반 1명을 최대한 지키도록 우선합니다.</div>
            <div class="divider"></div>


            <label>5. <strong style='font-size:1.05em'>분리요청 강도</strong><br><span class='subNote'>(같은 반이 되면 안 됨)</span></label>
            <select id="sepStrength">
              <option value="strict">엄격 (원칙적으로 같은 반 배정 금지)</option>
              <option value="strong" selected>강 (최대한 다른 반으로 분산)</option>
              <option value="medium">보통 (가급적 다른 반으로 분산)</option>
              <option value="weak">약함 (가능하면 분산, 여건에 따라 허용)</option>
            </select>

            <div style="margin-top:10px">
              <label>6. <strong style='font-size:1.05em'>배려요청 강도</strong><br><span class='subNote'>(같은 반이 되면 좋음)</span></label>
              <select id="careStrength">
                <option value="strict">엄격 (가능한 한 같은 반으로 배정)</option>
                <option value="strong" selected>강 (최대한 같은 반으로 배정)</option>
                <option value="medium">보통 (가급적 같은 반으로 배정)</option>
                <option value="weak">약함 (가능하면 같은 반, 여건에 따라 허용)</option>
              </select>
            </div>
          </div>
        </details>

        </div>
        <div class="stickyRun">
          <button id="runBtn" type="button" disabled>반배정 실행 → 결과 탭 보기</button>
          <div class="tip">결과가 마음에 안 들면 설정을 조금 조정하거나 다시 실행해 보세요 😊</div>
        </div>
      </aside>

      <section class="rightCol">
        <section class="card">
          <h2 class="panelTitle">📊 기본 통계</h2>
          <div class="innerCard"><div id="stats" class="small">엑셀을 업로드하면 통계/미리보기가 표시됩니다.</div></div>
        </section>

        <!-- 현재 설정 요약 (기본 통계 ↔ 미리보기 사이) -->
        <section class="card" id="settingsSummary" style="display:none;">
          <h2 class="panelTitle">🧾 현재 설정 요약</h2>
          <div class="innerCard"><div class="small" id="settingsSummaryLines">-</div></div>
        </section>

        <section class="card">
          <h2 class="panelTitle">🔎 미리보기(상위 20명)</h2>
          <div class="innerCard">
            <div id="legendPreview" class="small" style="opacity:0.9; margin-top:-4px; margin-bottom:6px;">아이콘 안내: 🧩 특수 │ 🌏 다문화 │ 🧠 ADHD │ 🔗 분리요청 │ 🤝 배려요청</div>
            <div id="errors" class="small danger"></div>
            <div style="overflow:auto; max-height: 420px;">
              <table id="previewTable"></table>
            </div>
          </div>
        </section>

        <section class="card" id="nextStepsCard" style="display:none;">
          <h2 class="panelTitle">👉 다음 단계</h2>
          <div class="small" id="nextStepsTxt">
            ① 반 개수를 확인합니다.<br/>
            ② 가중치를 기본값 그대로 사용하거나 필요 시 조정합니다.<br/>
            ③ <b>반배정 실행</b> 버튼을 눌러 결과 탭에서 확인합니다.
          </div>
        </section>
</section>
    </div>
  </section>

  <!-- RESULT TAB -->
  <section id="resultTab" style="display:none;">
    <div style="display:flex;flex-direction:column;gap:14px;">
      <section class="card">
        <h2 class="panelTitle">✅ 반배정 결과</h2>
        <div class="resultHeader">
          <div class="resultPills">
            <span class="pill ok" id="metaPill">-</span>
            <span class="pill warn" id="sepPill">분리 미충족: -</span>
            <span class="pill care" id="carePill">배려 미충족: -</span>
          </div>
          <button id="downloadBtn" class="downloadBtn" style="width:auto;"><span class="btnIcon">⬇️</span><span>결과 엑셀(.xlsx) 다운로드</span></button>
        </div>
      </section>

      <section class="chartGrid">
        <section class="card">
          <h2 class="panelTitle">📊 반별 요약</h2>
          <div id="classSummary" class="small">-</div>
        </section>
        <section class="card">
          <h2 class="panelTitle">⚠️ 결과 리포트</h2>
          <div id="violations" class="small">-</div>
        </section>
      </section>

      <section class="card" id="unsatisfiedCard">
        <h2 class="panelTitle">🔍 미충족 학생 목록</h2>
        <div class="noteBox small" style="margin-bottom:10px">
          • <b>분리 미충족</b>: 같은 <b>분리요청 그룹(상대학생)</b>이 같은 반에 함께 배정된 경우<br/>
          • <b>배려 미충족</b>: 같은 <b>배려요청 그룹(상대학생)</b> 친구가 <b>자기 반에 1명도 없는</b> 경우
        </div>
        
        <div class="unsatBlock">
          <div class="unsatTitle">분리 미충족 목록 <span class="small" id="unsatSepMeta"></span></div>
          <div style="height:8px"></div>
          <div style="overflow:auto; max-height: 280px;">
            <table id="unsatSepTable"></table>
          </div>
        </div>
        <div style="height:14px"></div>
        <div class="unsatBlock">
          <div class="unsatTitle">배려 미충족 목록 <span class="small" id="unsatCareMeta"></span></div>
          <div style="height:8px"></div>
          <div style="overflow:auto; max-height: 280px;">
            <table id="unsatCareTable"></table>
          </div>
        </div>
    
      </section>

      <section class="card">
        <h2 class="panelTitle">📈 그래프(반별 분포)</h2>
        <div class="small">* 안정성을 위해 차트는 반응형(responsive) OFF 상태로 렌더링합니다.</div>
        <div style="height:12px"></div>
        <div class="chartGrid">
          <div class="card" style="padding:12px;">
            <div class="small">반별 인원</div>
            <div class="chartBox"><canvas id="cntChart" height="260"></canvas></div>
          </div>
          <div class="card" style="padding:12px;">
            <div class="small">반별 남/여</div>
            <div class="chartBox"><canvas id="genderChart" height="260"></canvas></div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 class="panelTitle">📋 배정표</h2>
        <div style="overflow:auto; max-height: 560px;">
          <table id="resultTable"></table>
        </div>
      </section>
    </div>
  </section>

  </section>
</main>

<div class="overlay" id="overlay">
  <div class="box">
    <div class="row" style="gap:10px;">
      <span class="spinner"></span>
      <div>
        <div style="font-weight:900;">반배정을 계산 중…</div>
        <div class="small" id="progressTxt">시뮬레이션을 실행합니다.</div>
      </div>
    </div>
  </div>
</div>


<script>
(function(){
  function setStatus(txt){ var el=document.getElementById('statusPill'); if(el) el.textContent=txt; }
  function showErr(msg){
    var e=document.getElementById('errors');
    if(e){ e.textContent=msg; }
    setStatus('오류');
  }
  window.addEventListener('error', function(ev){
    showErr('스크립트 오류: ' + (ev && ev.message ? ev.message : ev));
  });
  window.addEventListener('unhandledrejection', function(ev){
    showErr('비동기 오류: ' + (ev && ev.reason ? (ev.reason.message || ev.reason) : ev));
  });
  window.addEventListener('DOMContentLoaded', function(){
    try{
      var inp=document.getElementById('fileInput');
      var fp=document.getElementById('filePill');
      if(inp){
        inp.addEventListener('change', function(){
          if(fp) fp.textContent = inp.files && inp.files[0] ? inp.files[0].name : '엑셀 미선택';
          setStatus('파일 선택됨');
        });
      }
      // CDN 로드 체크(5초 후)
      setTimeout(function(){
        if(!window.XLSX){
          showErr('엑셀 처리 라이브러리(XLSX)가 로드되지 않았습니다.\n학교/기관 네트워크에서 CDN이 차단된 경우가 많습니다.\n해결: 다른 네트워크(모바일 핫스팟 등)에서 접속하거나, "오프라인(라이브러리 포함)" 버전으로 교체하세요.');
        }
        if(!window.Chart){
          // 그래프만 실패할 수도 있음
          var e=document.getElementById('errors');
          if(e && !e.textContent){
            e.textContent = '그래프 라이브러리(Chart.js)가 로드되지 않았습니다.\n그래프 없이도 반배정은 가능하지만, 학교망에서 CDN 차단 시 발생할 수 있습니다.';
          }
        }
      }, 5000);
    }catch(_){}
  });
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="./app.js?v=344"></script>
</body>
</html>
