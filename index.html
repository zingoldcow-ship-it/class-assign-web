<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>반배정 도우미 (브라우저 전용)</title>
  <style>
    :root{ --bg:#0b1020; --card:#121a33; --text:#e9ecf1; --muted:#a9b1c6; --accent:#7aa2ff; --danger:#ff6b6b; --ok:#3ddc97; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{padding:16px;border-bottom:1px solid rgba(255,255,255,.08);position:sticky;top:0;background:rgba(11,16,32,.9);backdrop-filter:blur(8px);z-index:50;}
    .wrap{max-width:1300px;margin:0 auto;padding:14px;}
    h1{margin:0;font-size:18px;}
    .sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{font-size:12px;border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;color:var(--muted);}
    .pill.ok{border-color:rgba(61,220,151,.55);color:#c9ffe9}
    .pill.warn{border-color:rgba(255,107,107,.55);color:#ffd7d7}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tabBtn{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:800}
    .tabBtn.active{background:var(--accent);color:#071022;border-color:transparent}
    .app{display:grid;grid-template-columns:340px 1fr;gap:14px;align-items:start}
    @media (max-width: 980px){ .app{grid-template-columns:1fr;} }
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);}
    .panelTitle{font-size:14px;margin:0 0 10px 0;}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    /* Setup panel readability */
    #setupTab aside.card label{font-size:14px; line-height:1.25;}
    #setupTab aside.card input[type=file],
    #setupTab aside.card input[type=number],
    #setupTab aside.card select{font-size:15px;}




    input[type=file],input[type=number],select{width:100%;background:#0b1220;color:#e5e7eb;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;outline:none}
select:focus{border-color:rgba(96,165,250,.8)}
option{background:#0b1220;color:#e5e7eb}
    input[type=file]{padding:10px;border-radius:12px;border:1px dashed rgba(255,255,255,.18);background:rgba(255,255,255,.03);color:var(--text)}
    input[type=number],select{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);color:var(--text)}
    input[type=range]{width:100%;accent-color:var(--accent)}
    .kv{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin-top:6px}
    button{background:var(--accent);border:none;color:#071022;padding:11px 12px;border-radius:12px;font-weight:900;cursor:pointer;width:100%}
    .btnSecondary{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.14);color:var(--text)}
    button:disabled{opacity:.4;cursor:not-allowed}
    .small{font-size:12px;color:var(--muted)}
    .danger{color:var(--danger)}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:100;}
    .overlay .box{background:var(--card);border:1px solid rgba(255,255,255,.14);padding:16px;border-radius:14px;max-width:520px;width:calc(100% - 28px);}
    .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,.2);border-top-color:rgba(122,162,255,.9);animation:spin 1s linear infinite;display:inline-block;vertical-align:-4px;margin-right:8px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;text-align:left;white-space:nowrap}
    th{color:var(--muted);font-weight:600;position:sticky;top:0;background:rgba(18,26,51,.96)}
    .chartGrid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 980px){ .chartGrid{grid-template-columns:1fr;} }
    .chartBox{height:260px;position:relative}
    canvas{width:100% !important;height:100% !important;display:block}
    a{color:#b9c9ff}

    /* Accordion (설정 섹션 접기) */
    .acc{border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.03);padding:10px 12px;margin:10px 0;}
    /* 섹션 제목(기본 설정/학업·관계·민원·다문화 설정 등) 가독성 강화 */
    .acc > summary{cursor:pointer;list-style:none;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;font-weight:900;font-size:18px;color:var(--text);}
    .acc > summary::-webkit-details-marker{display:none;}
    .acc > summary .subline{display:block;font-weight:700;color:var(--muted);font-size:13px;margin-top:4px;}
    /* 토글(화살표)을 더 크게/눈에 띄게 */
    .acc > summary::after{content:"▾";opacity:.95;margin-top:2px;font-size:18px;transition:transform .15s ease;}
    details[open].acc > summary::after{transform:rotate(90deg)}
    .accInner{padding-top:10px;}

    /* Accordion 사용 안내 문구 */
    .accHint{font-size:16px;line-height:1.35;color:var(--text);font-weight:900;opacity:.95;}

    /* File upload button */
    .fileInputHidden{position:absolute;left:-9999px;width:1px;height:1px;opacity:0;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>📘 반배정 도우미 (브라우저 전용)</h1>
    <div class="sub">
      ① <b>샘플 양식</b>에 학생 정보를 입력 → ② 엑셀(.xlsx) 업로드 → ③ 설정(반 개수/가중치/분리·배려 강도) → ④ <b>반배정 실행</b> → ⑤ 결과 확인/엑셀 다운로드<br/>
      🔐 <b>모든 처리는 내 브라우저에서만</b> 이루어지며, 업로드한 파일과 데이터는 <b>어떤 서버로도 전송되지 않습니다</b>.
    </div>
    <div class="row" style="margin-top:10px">
      <span class="pill ok">서버 전송 없음</span>
      <span class="pill" id="filePill">엑셀 미선택</span>
      <span class="pill" id="rowsPill">0명</span>
      <span class="pill" id="statusPill">대기</span>
    </div>
    <div class="tabs">
      <button class="tabBtn active" id="tabSetup">설정</button>
      <button class="tabBtn" id="tabResult" disabled>결과</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- SETUP TAB -->
  <section id="setupTab">
    <div class="app">
      <aside class="card" style="position:sticky; top:120px;">
        <h2 class="panelTitle">⚙️ 설정</h2>
        <label>학생 데이터 엑셀(.xlsx)</label>
        <input id="fileInput" class="fileInputHidden" type="file" accept=".xlsx" />
        <button id="fileBtn" type="button" class="btnSecondary">엑셀 업로드</button>
        <div style="margin-top:10px">
          <a href="template.xlsx" download="반배정_양식_샘플(토글적용).xlsx" style="display:block;text-decoration:none">
            <button type="button" class="btnSecondary">샘플 양식 다운로드</button>
          </a>
        </div>
        <div class="small" style="margin-top:8px">* 처음 사용하시면 위 양식을 내려받아 <b>열 이름/형식</b>을 그대로 유지해 주세요.</div>
        <div class="divider"></div>

        <div class="accHint">①~③ 제목(번호)을 눌러 설정을 펼친 뒤 값을 확인/입력하세요.</div>

        <!-- ① 기본 설정 (기본으로 열려 있음) -->
        <details class="acc" open>
          <summary>
            <span>
              ① 기본 설정
              <span class="subline">(여기까지만 만져도 실행 가능)</span>
            </span>
          </summary>
          <div class="accInner">
            <label>1. 반 개수</label>
            <input id="classCount" type="number" min="2" max="30" value="10" />
            <div class="divider"></div>

            <label>2. 시뮬레이션 횟수(클수록 더 균형 / 느려질 수 있음)</label>
            <input id="iterations" type="number" min="200" max="60000" step="200" value="8000" />
            <div class="small">* 250명/10반 기준: 8,000~20,000 추천</div>
            <div class="divider"></div>

            <label>3. 배정 기준값(랜덤 시드: 같은 값이면 같은 결과)</label>
            <input id="seed" type="number" min="0" max="999999" value="42" />
          </div>
        </details>

        <!-- ② 학업·관계·민원·다문화 설정 (기본 접힘) -->
        <details class="acc">
          <summary>
            <span>
              ② 학업·관계·민원·다문화 설정
              <span class="subline">(가중치: 높을수록 더 많이 반영)</span>
            </span>
          </summary>
          <div class="accInner">
            <div class="small" style="margin-top:2px; opacity:.95;">* 가중치는 “반배정 점수” 계산에 사용됩니다. <b>값이 높을수록</b> 해당 항목이 반배정에 <b>더 강하게</b> 반영됩니다.</div>
            <div style="margin-top:10px">
              <label>4-1. 학업성취 가중치</label>
              <input id="wAcad" type="range" min="0" max="600" value="160" step="10" />
              <div class="kv"><span>0</span><span id="wAcadV">160</span><span>600</span></div>
            </div>
            <div style="margin-top:10px">
              <label>4-2. 교우관계 가중치</label>
              <input id="wPeer" type="range" min="0" max="600" value="160" step="10" />
              <div class="kv"><span>0</span><span id="wPeerV">160</span><span>600</span></div>
            </div>
            <div style="margin-top:10px">
              <label>4-3. 학부모민원 가중치</label>
              <input id="wParent" type="range" min="0" max="600" value="260" step="10" />
              <div class="kv"><span>0</span><span id="wParentV">260</span><span>600</span></div>
            </div>
            <div style="margin-top:10px">
              <label>4-4. 다문화학생 가중치</label>
              <input id="wMulti" type="range" min="0" max="600" value="160" step="10" />
              <div class="kv"><span>0</span><span id="wMultiV">160</span><span>600</span></div>
            </div>
          </div>
        </details>

        <!-- ③ 요청·제약 설정 (기본 접힘) -->
        <details class="acc">
          <summary>
            <span>
              ③ 요청·제약 설정
              <span class="subline">(분리·배려·특수한 상황 고려)</span>
            </span>
          </summary>
          <div class="accInner">
            <label>5. <strong style='font-size:1.05em'>ADHD 반당 최대 인원</strong>(제한)</label>
            <select id="adhdCap">
              <option value="auto" selected>자동(제한 없음 · 균등 분산 우선)</option>
              <option value="1">1명</option>
              <option value="2">2명</option>
              <option value="3">3명</option>
              <option value="4">4명</option>
              <option value="5">5명</option>
            </select>
            <div class="small" style="margin-top:8px">* 예: ADHD 30명 / 10반이라면 평균 3명입니다.<br> 현실적으로 불가능한 제한(예: 최대 1명)을 선택하면, 알고리즘은 <b>가능한 한</b> 제한을 지키도록 시도합니다.<br><br></div>

            <label>5-2. <strong style='font-size:1.05em'>특수학생 배정</strong>(3단계)</label>
            <select id="specialMode">
              <option value="off">미적용</option>
              <option value="medium" selected>보통 (가급적 반별 균등 분산)</option>
              <option value="strong">강 (가능한 한 균등 분산)</option>
            </select>
            <div class="small" style="margin-top:8px">* 엑셀에 <b>특수여부</b> 열이 있으면 Y/N로 인식합니다. (없으면 모두 N으로 처리)</div>
            <div class="divider"></div>

            <label>6. <strong style='font-size:1.05em'>다문화학생 배정</strong>(3단계)</label>
            <select id="multiMode">
              <option value="off" selected>미적용</option>
              <option value="medium">보통 (가급적 반별 균등 분산)</option>
              <option value="strong">강 (가능한 한 균등 분산)</option>
            </select>
            <div class="small" style="margin-top:8px">* 엑셀에 <b>다문화여부</b> 열이 있으면 Y/N로 인식합니다. (없으면 모두 N으로 처리)</div>
            <div class="divider"></div>

            <label>7. <strong style='font-size:1.05em'>분리요청 강도</strong>(같은 반이 되면 안 됨)</label>
            <select id="sepStrength">
              <option value="strict">엄격 (원칙적으로 같은 반 배정 금지)</option>
              <option value="strong" selected>강 (최대한 다른 반으로 분산)</option>
              <option value="medium">보통 (가급적 다른 반으로 분산)</option>
              <option value="weak">약함 (가능하면 분산, 여건에 따라 허용)</option>
            </select>

            <div style="margin-top:10px">
              <label>8. <strong style='font-size:1.05em'>배려요청 강도</strong>(같은 반이 되면 좋음)</label>
              <select id="careStrength">
                <option value="strict">엄격 (가능한 한 같은 반으로 배정)</option>
                <option value="strong" selected>강 (최대한 같은 반으로 배정)</option>
                <option value="medium">보통 (가급적 같은 반으로 배정)</option>
                <option value="weak">약함 (가능하면 같은 반, 여건에 따라 허용)</option>
              </select>
            </div>
          </div>
        </details>

        <button id="runBtn" type="button" disabled>반배정 실행 → 결과 탭 보기</button>
        <div class="small" style="margin-top:10px">
          TIP: 결과가 마음에 안 들면 <b>시드</b>를 바꾸거나 <b>시뮬레이션 횟수</b>를 늘려보세요.
        </div>
      </aside>

      <section style="display:flex; flex-direction:column; gap:14px;">
        <section class="card">
          <h2 class="panelTitle">📊 기본 통계</h2>
          <div id="stats" class="small">엑셀을 선택하면 통계/미리보기가 표시됩니다.</div>
        </section>

        <section class="card">
          <h2 class="panelTitle">🔎 미리보기(상위 20명)</h2>
          <div id="legendPreview" class="small" style="opacity:0.9; margin-top:-4px; margin-bottom:6px;">아이콘 안내: 🌏 다문화 │ 🧠 ADHD │ 🔗 분리요청 │ 🤝 배려요청</div>
          <div id="errors" class="small danger"></div>
          <div style="overflow:auto; max-height: 420px;">
            <table id="previewTable"></table>
          </div>
        </section>

        <section class="card" id="nextStepsCard" style="display:none;">
          <h2 class="panelTitle">👉 다음 단계</h2>
          <div class="small" id="nextStepsTxt">
            ① 반 개수를 확인합니다.<br/>
            ② 가중치를 기본값 그대로 사용하거나 필요 시 조정합니다.<br/>
            ③ <b>반배정 실행</b> 버튼을 눌러 결과 탭에서 확인합니다.
          </div>
        </section>

        <section class="card">
          <h2 class="panelTitle">🧭 안내</h2>
          <div class="small">
            • 결과는 <b>이 웹앱 내부의 “결과” 탭</b>에서 확인합니다.<br/>
            • 엑셀 열 이름(권장): 학생명, 성별, 학업성취, 교우관계, 학부모민원, 특수여부, ADHD여부, 분리요청학생, 배려요청학생, 비고<br/>
            • <b>분리학생</b>: '분리요청학생'에 같은 값을 넣은 학생끼리는 가능한 한 <b>다른 반</b>으로 배정(예: A1, A1)<br/>
            • <b>배려학생</b>: '배려요청학생'에 같은 값을 넣은 학생끼리는 가능한 한 <b>같은 반</b>으로 배정(예: B3, B3)
          </div>
        </section>
      </section>
    </div>
  </section>

  <!-- RESULT TAB -->
  <section id="resultTab" style="display:none;">
    <div style="display:flex;flex-direction:column;gap:14px;">
      <section class="card">
        <h2 class="panelTitle">✅ 반배정 결과</h2>
        <div class="row" style="justify-content:space-between;">
          <div class="row">
            <span class="pill ok" id="metaPill">-</span>
            <span class="pill" id="scorePill">Score: -</span>
            <span class="pill warn" id="sepPill">분리 위반: -</span>
            <span class="pill" id="carePill">배려 미충족: -</span>
          </div>
          <div class="row">
            <button id="downloadBtn" style="width:auto;">결과 엑셀 다운로드</button>
          </div>
        </div>
      </section>

      <section class="chartGrid">
        <section class="card">
          <h2 class="panelTitle">📊 반별 요약</h2>
          <div id="classSummary" class="small">-</div>
        </section>
        <section class="card">
          <h2 class="panelTitle">⚠️ 결과 리포트</h2>
          <div class="small">
            • <b>분리 위반</b>: 분리학생(같은 분리그룹)이 같은 반에 2명 이상 배정된 경우<br/>
            • <b>배려 미충족</b>: 배려학생(같은 배려그룹)이 여러 반으로 나뉜 정도<br/>
            • <b>학부모민원/학업성취/교우관계</b>: 반별로 ‘좋음/보통/나쁨’ 분포와 평균점수 편차를 요약합니다. (아래에서 <b>탭</b>으로 전환해 확인)
          </div>
          <div style="height:10px"></div>
          <div id="violations" class="small">-</div>
        </section>
      </section>

      <section class="card" id="unsatisfiedCard">
        <h2 class="panelTitle">🔍 미충족 학생 목록</h2>
        <div class="small" style="margin-bottom:10px">
          • <b>분리 미충족</b>은 ‘같은 분리요청학생(코드/상대학생)’이 같은 반에 함께 배정된 학생을 의미합니다.<br/>
          • <b>배려 미충족</b>은 ‘같은 배려요청학생(코드/상대학생)’ 친구가 <b>자기 반에 1명도 없는</b> 학생을 의미합니다.
        </div>
        <details open>
          <summary style="cursor:pointer; font-weight:900;">분리 미충족 목록 <span class="small" id="unsatSepMeta"></span></summary>
          <div style="height:8px"></div>
          <div style="overflow:auto; max-height: 280px;">
            <table id="unsatSepTable"></table>
          </div>
        </details>
        <div style="height:12px"></div>
        <details>
          <summary style="cursor:pointer; font-weight:900;">배려 미충족 목록 <span class="small" id="unsatCareMeta"></span></summary>
          <div style="height:8px"></div>
          <div style="overflow:auto; max-height: 280px;">
            <table id="unsatCareTable"></table>
          </div>
        </details>
      </section>

      <section class="card">
        <h2 class="panelTitle">📈 그래프(반별 분포)</h2>
        <div class="small">* 안정성을 위해 차트는 반응형(responsive) OFF 상태로 렌더링합니다.</div>
        <div style="height:12px"></div>
        <div class="chartGrid">
          <div class="card" style="padding:12px;">
            <div class="small">반별 인원</div>
            <div class="chartBox"><canvas id="cntChart" height="260"></canvas></div>
          </div>
          <div class="card" style="padding:12px;">
            <div class="small">반별 남/여</div>
            <div class="chartBox"><canvas id="genderChart" height="260"></canvas></div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2 class="panelTitle">📋 배정표</h2>
        <div id="legendResult" class="small" style="opacity:0.9; margin-top:-4px; margin-bottom:6px;">아이콘 안내: 🌏 다문화 │ 🧠 ADHD │ 🔗 분리요청 │ 🤝 배려요청</div>
        <div class="row" style="margin-bottom:10px;">
          <label class="small">반 필터</label>
          <select id="classFilter"></select>
          <span class="small" id="tableMeta"></span>
        </div>
        <div id="legendResult" class="small" style="opacity:0.9; margin-top:-6px; margin-bottom:10px;">아이콘 안내: 🌏 다문화 │ 🧠 ADHD │ 🔗 분리요청 │ 🤝 배려요청</div>
        <div style="overflow:auto; max-height: 560px;">
          <table id="resultTable"></table>
        </div>
      </section>
    </div>
  </section>
</main>

<div class="overlay" id="overlay">
  <div class="box">
    <div class="row" style="gap:10px;">
      <span class="spinner"></span>
      <div>
        <div style="font-weight:900;">반배정을 계산 중…</div>
        <div class="small" id="progressTxt">시뮬레이션을 실행합니다.</div>
      </div>
    </div>
  </div>
</div>


<script>
(function(){
  function setStatus(txt){ var el=document.getElementById('statusPill'); if(el) el.textContent=txt; }
  function showErr(msg){
    var e=document.getElementById('errors');
    if(e){ e.textContent=msg; }
    setStatus('오류');
  }
  window.addEventListener('error', function(ev){
    showErr('스크립트 오류: ' + (ev && ev.message ? ev.message : ev));
  });
  window.addEventListener('unhandledrejection', function(ev){
    showErr('비동기 오류: ' + (ev && ev.reason ? (ev.reason.message || ev.reason) : ev));
  });
  window.addEventListener('DOMContentLoaded', function(){
    try{
      var inp=document.getElementById('fileInput');
      var fp=document.getElementById('filePill');
      if(inp){
        inp.addEventListener('change', function(){
          if(fp) fp.textContent = inp.files && inp.files[0] ? inp.files[0].name : '엑셀 미선택';
          setStatus('파일 선택됨');
        });
      }
      // CDN 로드 체크(5초 후)
      setTimeout(function(){
        if(!window.XLSX){
          showErr('엑셀 처리 라이브러리(XLSX)가 로드되지 않았습니다.\n학교/기관 네트워크에서 CDN이 차단된 경우가 많습니다.\n해결: 다른 네트워크(모바일 핫스팟 등)에서 접속하거나, "오프라인(라이브러리 포함)" 버전으로 교체하세요.');
        }
        if(!window.Chart){
          // 그래프만 실패할 수도 있음
          var e=document.getElementById('errors');
          if(e && !e.textContent){
            e.textContent = '그래프 라이브러리(Chart.js)가 로드되지 않았습니다.\n그래프 없이도 반배정은 가능하지만, 학교망에서 CDN 차단 시 발생할 수 있습니다.';
          }
        }
      }, 5000);
    }catch(_){}
  });
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="./app.js?v=343"></script>
</body>
</html>
